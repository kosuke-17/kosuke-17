# 3. EC2 に必要なパッケージをインストール

## 3.1 Apache

### 3.1.1 Apache インストール

```bash
sudo yum install httpd
sudo systemctl enable httpd
```

### 3.1.2 Apache 起動

```bash
sudo systemctl start httpd
```

### 3.1.3 Apache 起動ステータス確認

```bash
sudo systemctl status httpd
```

### 3.1.4 インスタンス軌道とともに Apache サーバーが起動する設定

```bash
sudo systemctl enable httpd
```

- yum : パッケージ管理ツール
  - https://wa3.i-3-i.info/word11834.html
  - この前は rpm があった
  - この後に dnf が出てきた
- httpd
  - Apache HTTP Server のこと
  - https://httpd.apache.org/

## 3.2 PHP

### 3.2.1 amazon-linux-extras コマンドでインストールに使うリポジトリを指定

```bash
sudo amazon-linux-extras install php7.2
```

### 3.2.2 php をインストール

```bash
sudo yum install php
```

## 3.3 MySQL

### 3.3.1 デフォルトで mariadb が入っているかを調べる。

```bash
yum list installed | grep mariadb
```

### 3.3.2 入っている場合は削除する。

```bash
sudo yum remove mariadb-libs
# 必要があれば行う
sudo rm -rf /var/lib/mysql
```

### 3.3.3 エラーが出るので事前に import 事前に`RPM-GPG-KEY-mysql-2022`をダウンロードしておく。

```bash
sudo rpm --import https://repo.mysql.com/RPM-GPG-KEY-mysql-2022
```

### 3.3.4 MySQL 関連のパッケージをインストールする

```bash
sudo yum localinstall https://dev.mysql.com/get/mysql80-community-release-el7-5.noarch.rpm
sudo yum install mysql-community-server
```

### 3.3.5 MySQL を起動する

```bash
# 起動
sudo systemctl start mysqld
# ステータス確認
sudo systemctl status mysqld
# インスタンス起動とともにMySQLサーバーも起動する設定
sudo systemctl enable mysqld
```

### 3.3.6 MySQL にログインして作業できるまで

- ログイン

```bash
# ログインの初期パスワードを取得
sudo cat /var/log/mysqld.log | grep localhost
## A temporary password is generated for root@localhost: tWt:b;bMd7aa
## 「tWt:b;bMd7aa」がpassword

# ログインパスワードを変えてみる
alter user root@localhost identified by 'aat:k;eMd7op';
## もし、alter user root@localhost identified by 'password';と入力したら
## Your password does not satisfy the current policy requirementsと怒られる
## パスワードの基準を低くすることもできる模様(仕事では使わなさそう)
## https://qiita.com/isao_e_dev/items/4bf590788b79932bbeb0

# rootユーザーでログイン
mysql -u root -p
```

- DB 作成

```
<!-- DB作成前の確認 -->
mysql> show databases;

+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+

<!-- DB名はスネークケース -->
mysql> create database wordpress_db;
mysql> show databases;

<!-- DB作成後後の確認 -->
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
| wordpress_db       |
+--------------------+
```

- 新規でユーザー作成
  - ユーザー名はスネークケース

```bash
create user tamura_ko@localhost identified with mysql_native_password by 'rQe:b;bMd7dd';
# 作成した新規ユーザーのデータベースを利用する権限を付与
grant all privileges on wordpress_db.* to tamura_ko@localhost;
flush privileges;

exitする

# 作成したユーザーで入れるか確認
mysql -u tamura_ko -p

# パスワード入力: rQe:b;bMd7dd
```

参考

- https://qiita.com/miriwo/items/e7afd5e1ae0de94f27c2
- https://qiita.com/yasushi-jp/items/1d6b3f0a96dd13727e20
- https://mylops.jp/blog/000073.html
- https://qiita.com/Teru_3/items/0de3bb3476d754f1aabe
- https://qiita.com/takumifujiwaradairy/items/28d96135453457855e70
- https://qiita.com/kidatti/items/a6393e26d823bc42727a
- https://qiita.com/nii_yan/items/0265f69370bbdb883655
- https://dev.mysql.com/doc/refman/8.0/ja/connecting.html
- https://zenn.dev/sway/articles/aws_publish_apache
- https://qiita.com/Teru_3/items/0de3bb3476d754f1aabe

## 3.4 WordPress

### WordPress を DL し解凍後に html ディレクトリに移動

```bash
sudo wget http://ja.wordpress.org/latest-ja.tar.gz
sudo tar -xzvf latest-ja.tar.gz
sudo cp -r wordpress/* /var/www/html
```

### Apache サーバーが WordPress を読み取れるように設定し再起動

```bash
sudo chown apache:apache /var/www/html/ -R
sudo systemctl restart httpd.service
```

### EC2 インスタンスのパブリック IP アドレスをブラウザに入れて画面表示して以下の DB 情報を入力して完成

- DB 情報入力画面
  - username: tamura_ko
  - password(user の pw?): rQe:b;bMd7dd
  - database: wordpress_db
  - host: localhost
- サイト情報入力画面
  - サイト: WordPress を EC2 で起動させる練習
  - ユーザー名: kosuke
  - wp の pw: bn5sW&BnmmUpn)Hndc
