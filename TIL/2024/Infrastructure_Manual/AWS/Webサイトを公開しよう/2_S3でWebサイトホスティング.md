# 2 S3 で Web サイトホスティング

- S3 を管理操作できるのは「S3FullAccess」というポリシーが必要

## 2-1 S3 バケット作成

独自のドメインでアクセスするには、それと同じ名前でバケット名を作成しなければならない

### 2.1.1 一般的な設定

- バケット名
  - tamusite.com
- オブジェクト所有者
  - ACL 無効
    - 他の AWS アカウントも所有者となれるかどうか
- このバケットのブロックパブリックアクセス設定
  - パブリックアクセスを全てブロック
    - チェックを外す
    - 誰でもこの S3 バケットにアクセスできるようにする
      - 誰でも見れてしまうため、警告メッセージのチェックボックスが表示されるので見てチェックする
- バケットのバージョニング
  - 同名のファイルを上書きするときに版を残すかどうか
  - 無効にする
- タグオプション
  - 未設定
- デフォルトの暗号化
  - デフォルトの「Amazon S3 マネージドキーを使用したサーバー側の暗号化」を利用
- 詳細オプションにあるオブジェクトのロックの設定は法律上の理由で、特別な権限がない限り上書きや削除を制限するものなので「無効にする」のままにする

## 2.2 静的ウェブサイトホスティング機能を有効にする

- S3 バケットの詳細 > プロパティのタブに移動

### 2.2.1 以下の内容を編集する

- 静的 web サイトホスティングの編集
  - 有効にする
  - ホスティングタイプ
    - 今回は「静的 web サイト」を選択
  - インデックスドキュメント
    - `/`で終わる URL を指定したときに返すファイル
    - `index.html`を指定
  - エラードキュメント
    - 指定したファイルがないときなど、何かしらのエラーが発生したときに返すページを構成するファイル
  - リダイレクトルール
    - 特定の URL が指定されたときに別の URL にリダイレクトするための設定
- 変更の保存をする

### 2.2.2 静的 web サイトのエンドポイントを確認

- `http://バケット名.s3.website-ap-リージョンコード.amazonaws.com/`

## 2.3 バケットポリシーの設定

### 2.3.1 作成したエンドポイントをブラウザでアクセスしようとしても、AccessDenied というエラーが表示される

- そのため、バケットポリシーを付与する

- S3 バケットの詳細 > アクセス許可のタブに移動

### 2.3.2 「パブリックアクセスを全てブロック」の設定がオフになっているのを確認

- オンになっていたら、全てのチェックを外して編集する

### 2.3.3 バケットポリシーを編集

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "PublicReadGetObject", // ポリシーの名称
            "Effect": "Allow", // 許諾の種類
            "Principal": "*", // 誰に対して
            "Action": [ // どんな操作を
                "s3:GetObject" // 読み取りの操作
            ],
            "Resource": [ // 何に対して
                "arn:aws:s3:::tamusite.com/*" // 対象
            ]
        }
    ]
}
```

- https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/WebsiteAccessPermissionsReqd.html
- s3 バケットのファイルを保護するために
  - https://repost.aws/ja/knowledge-center/secure-s3-resources

## 2.4 公開するファイルをアップロード

### 2.4.1 S3 のエンドポイントにアクセスすると、404 が表示されていることを確認

### 2.4.2 1 で作成した静的なサイトをアップロードする

- index.html があることを確認してアップロードする

### 2.4.3 もう一度、S3 のエンドポイントにアクセスして、サイトが表示されていることを確認

- Github Actions と AWS CLI などを用いて、静的サイトを継続的に上げるような仕組みづくりをすると、運用が楽になる
