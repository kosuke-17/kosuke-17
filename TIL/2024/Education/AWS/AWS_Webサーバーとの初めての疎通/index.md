# AWS Web サーバーとの初めての疎通

ECS にコンテナを立ち上げて、ALB で向き先を変えるようにしました
ECR の Image を ECS が Pull できるようにする

## 事前準備

- Next.js の web アプリを用意
  - DB アクセスはしない前提
  - 静的なサイト

## 1.VPC の作成

- Subnet の作成
  - Public subnet
    - 外部との通信を行う Subnet
    - Private subnet を作って AWS リソースを割り当てる場合は VPC エンドポイントや Nat gateway などを使用することで S3 や ECR などのリソースにアクセスすることができる
- Route table の作成
  - サブネットの振り分けを行う
- Internet gateway の作成
  - これを Route table と紐づけることでインターネットとの通信を行う
- Security group の作成

  - ALB 用
    - ブラウザから通信をする場合はタイプを HTTP(port:80) にして、ソースを `0.0.0.0/0`とする
      - ブラウザの url はデフォルトで port が 80 となるため
    - 80 以外の port をブラウザから指定したい場合(port:3000 など)、タイプをカスタム TCP として port を 3000 とすることで`http://xxxxxxxx:3000`と指定することができる
    - ソース部分は Security group を指定することができ、その場合は VPC 内部で通信を行う場合に使うことがある(クライアントから api サーバーにリクエストを投げるときなど)
  - ECS 用?
    - ECS はタイプをカスタム TCP の port3000、ソースを`0.0.0.0/0`とすれば許可される
    - ソース部分を特定の IP にすることでより制御できそう(要調査)
  - 任意: RDS 用

    - db によってタイプがことなる
      - posgresql のタイプの場合はポートが指定されて、特定の sg を指定する必要がありそう

  - セキュリティグループを同じ VPC 内の複数のインスタンスに設定すると、インスタンス間の通信がすべて許可されることになる
    - https://ent.iij.ad.jp/articles/1486/
    - https://www.cloudsolution.tokai-com.co.jp/white-paper/2023/0727-405.html

## 2.ALB の作成

- ALB の作成

  - 今回は web サーバーなのでインターネット向けにする
    - api サーバーの場合は内部にする
    - 2 つ以上のサブネットを指定する
    - セキュリティグループは ALB 用のものを指定
  - リスナールールの作成
    - 受信を待っている
    - port80 を指定してるルールを作成
  - ターゲットグループの作成

    - ターゲットはこの時点で登録しなくても良い
      - ECS のサービス作成時に ALB を指定するため

  - リスナーとルールで別のポートにリダイレクトの設定ができる

    - 503 ページや 404 ページへのリダイレクトも可能
      - 特定のリスナーとルールの詳細で行うかも？(要調査)

  - ヘルスチェック
    - path をきちんと設定する
    - rails の場合はヘルスチェック用のパスを許可する必要がある
      - host_authorization にヘルスチェックのパスを指定するなど

## 3. ECR の作成

- リポジトリの作成
  - 今回は brain-breeze-web-ecr と命名
  - 作成されたリポジトリの URI をコピペしておく
    - Task Definition を作成するときに Image の指定で必要なため
- tag の命名はよくわかってないので調べる必要がある(要調査)
- リポジトリに Image を push するコマンドを叩くことでローカルにある Image を ECR に上げる
  - 手段
    - AWS CLI
    - CI/CD
      - Github Actions
      - Circle CI など

## 4. ECS の作成

- Cluster の作成
  - Fargate を選択
- Task Definition の作成
  - latest と命名することで最新の Image を使うことになる模様
  - コンテナポートは、3000 を選択（Dockerfile で指定してるポート番号による）
  - 必要があれば環境変数を指定
    - 最近の Rails は`RAILS_ENV`や`RAILS_MASTER_KEY`を使用するのがよさそう
    - DB 情報などの secrets manager を使って管理する方がセキュリティリスクを抑えられる
  - ログ出力の設定もしておくと、デバックしやすくなる
- Service の作成

  - 最新のリビジョンの task definition を指定
  - 必要なタスクを選択
  - Task が作成される
  - ブルーグリーンデプロイかローリングアップデートを選択(要調査)
    - 前者の場合は CodeDeploy を使用する
  - ネットワーキングの選択
    - subnet の選択
    - security group の選択
  - ALB の選択
    - ロードバランサーとコンテナを選択
      - 今回は port が 3000 のコンテナを選択
      - リスナーとターゲットグループを選択
        - 既存で作成しているリスナーとターゲットグループを使用
        - ここでターゲットに登録されて、ALB からトラフィックが流れてくる

## 5. サイトの確認

- ALB の dns を用いてブラウザから web サーバーにアクセスが可能かを確認

  - sg の設定や alb のリスナー、ターゲットグループ、ヘルスチェックがうまくいって初めてサイトが表示される

- basic 認証はどこで設定する?
